name: Validate bicep scripts
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true  # Azureèªè¨¼ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ã¯ç¶šè¡Œ

      - name: Validate Bicep syntax
        uses: azure/CLI@v1
        id: bicep-validation
        continue-on-error: true  # ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶šè¡Œ
        with:
          azcliversion: latest  # æ˜ç¤ºçš„ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          inlineScript: |
            echo "Setting up Bicep configuration..."
            az config set bicep.use_binary_from_path=false
            az config set core.only_show_errors=false
            
            echo "Checking Bicep version..."
            az bicep version
            
            echo "Building Bicep template..."
            if az bicep build -f infra/main.bicep --stdout > bicep-output.log 2>&1; then
              echo "âœ… Bicep build succeeded"
              echo "bicep_build_success=true" >> $GITHUB_OUTPUT
              echo "BICEP_BUILD_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "âŒ Bicep build failed"
              echo "bicep_build_success=false" >> $GITHUB_OUTPUT
              echo "BICEP_BUILD_SUCCESS=false" >> $GITHUB_ENV
              echo "Bicep build errors detected. Please check the logs above."
              cat bicep-output.log
            fi

      - name: Upload Bicep build logs
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('bicep-output.log') != ''
        with:
          name: bicep-build-logs
          path: bicep-output.log
          retention-days: 30

      - name: Lint Bicep files
        uses: azure/CLI@v1
        continue-on-error: true
        if: env.BICEP_BUILD_SUCCESS == 'true'
        with:
          azcliversion: latest
          inlineScript: |
            echo "Running Bicep linter..."
            az bicep build -f infra/main.bicep --verbose > bicep-lint.log 2>&1
            
            # è­¦å‘Šã®ã‚«ã‚¦ãƒ³ãƒˆ
            warning_count=$(grep -c "Warning" bicep-lint.log || echo "0")
            echo "Found $warning_count warnings"
            echo "bicep_warning_count=$warning_count" >> $GITHUB_OUTPUT
            echo "BICEP_WARNING_COUNT=$warning_count" >> $GITHUB_ENV

      - name: Upload Bicep lint logs
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('bicep-lint.log') != ''
        with:
          name: bicep-lint-logs
          path: bicep-lint.log
          retention-days: 30

      - name: Comment PR with Bicep results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const buildSuccess = process.env.BICEP_BUILD_SUCCESS === 'true';
            const warningCount = process.env.BICEP_WARNING_COUNT || '0';
            
            let message = '## ğŸ”§ Bicep Validation Results\n\n';
            
            if (buildSuccess) {
              message += 'âœ… **Build Status**: Success\n';
              message += `âš ï¸ **Warnings**: ${warningCount}\n\n`;
              if (parseInt(warningCount) > 0) {
                message += '**Recommendations**:\n';
                message += '- Consider addressing the warnings to improve code quality\n';
                message += '- Check the bicep-lint-logs artifact for details\n';
              }
            } else {
              message += 'âŒ **Build Status**: Failed\n\n';
              message += '**Action Required**:\n';
              message += '- Fix the Bicep template errors before merging\n';
              message += '- Check the bicep-build-logs artifact for detailed error information\n';
              message += '- Common issues:\n';
              message += '  - Invalid property names (e.g., `raiPolicyName`)\n';
              message += '  - Missing parent properties in child resources\n';
              message += '  - Outdated API versions\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Run Microsoft Security DevOps Analysis
        uses: microsoft/security-devops-action@preview
        id: msdo
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã¯Bicepãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: env.BICEP_BUILD_SUCCESS == 'true'
        continue-on-error: true
        with:
          tools: templateanalyzer
        env:
          GDN_TEMPLATEANALYZER_VERBOSE: 1

      - name: Upload alerts to Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: steps.msdo.outputs.sarifFile && env.BICEP_BUILD_SUCCESS == 'true'
        continue-on-error: true
        with:
          sarif_file: ${{ steps.msdo.outputs.sarifFile }}

      - name: Set job status
        if: always()
        run: |
          echo "BICEP_BUILD_SUCCESS value: '$BICEP_BUILD_SUCCESS'"
          if [[ "$BICEP_BUILD_SUCCESS" == "true" ]]; then
            echo "âœ… Workflow completed successfully"
            exit 0
          else
            echo "âŒ Workflow completed with errors - please fix Bicep template issues"
            exit 1
          fi